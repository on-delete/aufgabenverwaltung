package de.saxsys.server;

import io.vertx.core.AbstractVerticle;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.jdbc.JDBCClient;

/**
 * Created by andre.krause on 29.07.2015.
 */
public class InitDatabaseVerticle extends AbstractVerticle{

	public void start(){
		final JDBCClient client = JDBCClient.createShared(vertx, new JsonObject()
				.put("url", "jdbc:hsqldb:file:db/aufgabenDB")
				.put("driver_class", "org.hsqldb.jdbcDriver")
				.put("max_pool_size", 30));

		client.getConnection(conn -> {
			if (conn.failed()) {
				System.err.println(conn.cause().getMessage());
				return;
			}


			conn.result().execute("create sequence u_id_squence", voidAsyncResult -> {
			});
			conn.result().execute("create table userstory(u_id bigint GENERATED BY DEFAULT AS SEQUENCE u_id_squence PRIMARY KEY, u_title varchar(255) NOT NULL, u_description varchar(255), u_priority varchar(255) NOT NULL);", res -> {
				if (res.succeeded())
					System.out.println("Erfolgreich!");
				else
					System.out.println(res.cause().getMessage());
			});
			conn.result().execute("create sequence t_id_squence", voidAsyncResult -> {
			});
			conn.result().execute("create table task(t_id bigint GENERATED BY DEFAULT AS SEQUENCE t_id_squence PRIMARY KEY, u_title varchar(255) NOT NULL, u_description varchar(255), u_priority varchar(255) NOT NULL, inCharge varchar(255), u_id bigint NOT NULL, FOREIGN KEY(u_id) REFERENCES userstory(u_id) ON DELETE CASCADE);", res->{
				if(!res.succeeded()){
					System.out.println(res.cause().getMessage());
				}
			});
			/*conn.result().execute("insert into userstory values (NEXT VALUE FOR u_id_squence, 'userstory 1', '', 'HIGH');", res -> {
				if(!res.succeeded()){
					System.out.println(res.cause().getMessage());
				}
			});
			conn.result().execute("insert into task values (NEXT VALUE FOR t_id_squence, 'task 1', '', 'HIGH', 'Andre', (SELECT u_id FROM userstory WHERE u_id=1));", res -> {
				if(!res.succeeded()){
					System.out.println(res.cause().getMessage());
				}
			});
*/

		});
	}
}
